<script>
const params = new URLSearchParams(window.location.search);
const userId = params.get("userId");
const auctionId = params.get("auctionId");

let calculatedAmount = 0;

// Load user address + item price
$(document).ready(function(){

    /** Load user billing address **/
    $.ajax({
        url: "http://localhost:8080/studentapp/api/users/" + userId,
        type: "GET",
        success: function(user){
            $("#billingName").val(user.fullName);
            $("#billingAddress").val(user.address);
            $("#city").val(user.city);
            $("#state").val(user.state);
            $("#postalCode").val(user.postalCode);
            $("#country").val(user.country);
        }
    });

    /** Load auction item details **/
    $.ajax({
        url: "http://localhost:8080/studentapp/api/auctions/" + auctionId,
        type: "GET",
        success: function(auction){

            calculatedAmount = auction.winningBid + auction.shippingCost;

            $("#orderInfo").html(
                "Item: " + auction.itemName + "<br>" +
                "Winning Bid: $" + auction.winningBid + "<br>" +
                "Shipping: $" + auction.shippingCost + "<br>" +
                "<b>Total Amount: $" + calculatedAmount + "</b>"
            );
        }
    });
});


// SUBMIT PAYMENT
$("#paymentForm").submit(function(e){
    e.preventDefault();

    const paymentData = {
        userId: userId,
        auctionId: auctionId,
        amount: calculatedAmount,

        billingName: $("#billingName").val(),
        billingAddress: $("#billingAddress").val(),
        city: $("#city").val(),
        state: $("#state").val(),
        postalCode: $("#postalCode").val(),
        country: $("#country").val(),

        cardHolderName: $("#cardHolderName").val(),
        cardNumber: $("#cardNumber").val(),
        cardType: $("#cardType").val(),
        expiryDate: $("#expiryDate").val()
    };

    $.ajax({
        url: "http://localhost:8080/studentapp/api/payments",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(paymentData),
        success: function(result){
            // Backend should return: paymentId
            window.location.href = "Receipt.html?paymentId=" + result.paymentId;
        },
        error: function(err){
            console.log(err);
            $("#paymentMessage").text("Payment failed.");
        }
    });
});
</script>
